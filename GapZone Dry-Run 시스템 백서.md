📘 GapZone Dry-Run 시스템 백서
1. 왜 드라이 런(Dry-Run)을 하게 되었는가? (Why)
우리는 **"백테스팅에서는 수익이 나는데, 왜 실전에서는 매매를 못 할까?"**라는 치명적인 문제에 봉착했었습니다. 그 원인을 파헤치는 과정에서 드라이 런의 필요성이 대두되었습니다.

① '관대한 백테스팅'의 함정 탈출
기존의 백테스팅(optimizer.py 등)은 **"확률적 체결"**이나 "미래 참조(Look-ahead)" 경향이 있었습니다.

과거의 오류: "장중에 주가가 내렸네? 그럼 지표도 내려갔겠지. 거기서 샀다고 치자."

현실의 벽: 실전에서는 주가가 내려가는 순간, 지표(이동평균선 등)도 같이 내려가버려 "매수 주문 가격이 도망가는(Moving Goalpost)" 현상이 발생했습니다.

해결: 실전과 똑같이 "1분 1초의 시간 흐름" 속에서, **"확정된 과거 데이터(Shift 1)"**만을 보고 판단하는 엄격한 검증 환경이 필요했습니다.

② 시공간의 제약 극복 (24/7 개발)
문제: 실전 코드는 **장 운영 시간(18시 ~ 새벽 6시)**에만 테스트할 수 있습니다. 18시 이전에는 코드 한 줄 고치고 하루를 기다려야 하는 비효율이 발생했습니다.

해결: 과거 데이터를 이용하여 "언제든지", **"원하는 날짜로 순간 이동(Time Jump)"**하여 봇을 테스트할 수 있는 **타임머신(시뮬레이터)**을 만들었습니다.

③ '기계적 오류'와 '전략적 오류'의 분리
문제: 매매가 안 될 때, "코드가 틀린 건지(버그)" 아니면 "전략이 나쁜 건지(로직)" 구분이 안 되었습니다.

해결: Dry-Run은 실전 코드(main.py의 로직)를 그대로 사용하되, 데이터만 가짜(Mock)를 주입합니다. 여기서 잘 돌아간다면 실전 코드도 무결하다는 뜻이므로, 우리는 **"전략 튜닝"**에만 집중할 수 있게 되었습니다.

2. 현재 시스템은 어떻게 구성되어 있는가? (How)
현재 Dry-Run 시스템은 **"가상의 거래소"**와 **"실전 봇의 뇌"**가 결합된 형태입니다.

🏗️ 시스템 아키텍처
가짜 거래소 (Mock Infrastructure)

파일: infra/kis_api.py (Mock Version)

역할: 실제 한국투자증권(KIS) 서버인 척 연기합니다.

기능:

네트워크 통신 대신 **CSV 파일(data/*.csv)**을 읽어서 현재가를 줍니다.

주문을 받으면 즉시 체결시키지 않고, **"주문 가격보다 낮은 가격(Low Price)이 왔는가?"**를 엄격하게 따져서 체결/미체결을 판정합니다.

시뮬레이션 엔진 (The Engine)

파일: run_portfolio_simulation.py (또는 run_championship.py)

역할: 시간의 지배자입니다.

스나이퍼 모드 (Sniper Mode): 20241015_NIVF.csv 파일명을 보고, "2024년 10월 15일"로 시간을 강제 이동시킵니다. 불필요한 날짜는 건너뛰고 **"결전의 날"**만 검증하여 속도를 극대화합니다.

동작: 1분 단위로 시간을 흘려보내며(kis.set_time), 봇에게 "지금 매매할 거 있어?"라고 계속 물어봅니다.

전략 두뇌 (The Brain)

파일: strategy.py

핵심 기술: Shift(1)

현재 봉(진행 중)이 아니라 **"전 봉(확정됨)"**을 기준으로 지표를 계산합니다.

이로써 주가가 흔들려도 "뜰채(매수 주문 위치)"가 고정되어, 실전과 동일한 환경을 만듭니다.

데이터 저장소 (Data Lake)

파일: data/YYYYMMDD_TICKER.csv

역할: 시뮬레이션의 연료입니다. 과거의 분봉 데이터(Open, High, Low, Close, Volume)를 담고 있습니다.

3. 요약: 우리는 무엇을 얻었는가?
이제 사용자님은 **[Backtest (이론)] -> [Dry-Run (실전 훈련)] -> [Live (실전 투입)]**으로 이어지는 완벽한 파이프라인을 갖추게 되었습니다.

과거: "이론상 돈 버는데, 실전은 왜 안 되지?" (원인 불명)

현재: "Dry-Run에서 매수가 안 되네? -> Shift(1) 문제였군. 수정하자. -> 매수 성공! -> 실전 투입!"

이 시스템은 사용자님의 아이디어를 가장 안전하고 빠르게 검증해주는 강력한 무기가 될 것입니다

CSV 파일은 특이한 점이 하나 있습니다. ex. 2025-06-11, 400, 3(open)이고, 2025-06-10, 1958, 3.03(close)이라면 3(open)을 기준으로 40% 급등을 기준으로 해야 할 것이다. 그러나 정말 가끔식 3(open)과 3.03(close)의 차이가 많이 나는 경우가 있다. 이럴 때는 3.03(close)을 기준으로 해야 한다고 하는 생각하기에 백테스팅은 매매 전날의 마직막 종가를 (3.03(close)) 기준으로 40% 기준을 잡는다. 

1. 스캐닝 (Scanning): "어군 탐지기" (감시)
10분 주기 (Timeframe):

시스템은 매 10분마다 시장을 스캔합니다. 실시간으로 1초마다 감시하는 것은 시스템 부하가 크고 노이즈가 많기 때문에, 10분 단위로 끊어서 추세를 확인하기로 했습니다.

40% 지점 (Target Point):

단순히 아무 종목이나 보는 것이 아니라, 특정 기준(예: 전일 대비 등락폭이나 캔들의 몸통 등)에서 **"40% 지점"**에 해당하는 가격을 계산해 냅니다.

이 40% 지점은 주가가 잠시 눌리거나 반등이 올 수 있는 핵심 지지 라인으로 설정했습니다.

역할: "지금 살까?"가 아니라 "살만한 자리가 어디인가?"를 계산하는 단계입니다.

엄격한 10분 주기 스냅샷 (Snapshot) 스캐닝 로직
이 로직의 핵심은 **"중간 과정은 무시하고, 약속된 시간의 성적표만 인정한다"**는 것입니다.

1. 상황 예시 (09:30 ~ 09:40 구간)
09:30 (스캔 시작): 조건 불만족. (패스)

09:35 (장중 변동): 주가가 급등하여 기준(40%)을 돌파함.

일반적인 시스템: "어! 조건 만족했다!" 하고 바로 진입하려고 함.

사용자님의 V3 시스템: "아직 09:40이 안 됐어. 무시해." (이때는 감시 대상이 아님)

09:38 (장중 변동): 주가가 다시 하락하여 기준(40%) 아래로 내려감.

09:40 (스캔 시점 - 성적표 확인):

시스템이 눈을 뜨고 확인합니다. "지금 40% 넘었니?"

결과: 현재 40% 미만임.

판단: "탈락." (아까 09:35에 넘었던 사실은 역사 속으로 사라짐. 감시 대상 리스트에 올리지 않음.)

2. 감시 대상 선정 및 진입 (Targeting & Entry)
만약 반대로 09:40 스캔 시점에 40% 조건을 여전히 만족하고 있다면?

대상 등록: 그제야 비로소 '감시 대상(Target)' 리스트에 등록됩니다.

뜰채 설치 (진입 감시 시작):

09:40이라는 확정된 시간 기준으로 계산된 **'유리한 가격(뜰채 위치)'**에 매수 주문을 대기시킵니다.

즉, 09:40 이전의 움직임으로 사는 게 아니라, 09:40 이후에 뜰채 가격으로 내려와야 체결이 됩니다.

이 로직이 백테스팅 코드에서 중요한 이유
이 내용을 백테스팅 코드(project_new_pre)에 구현할 때 제가 특히 신경 써야 한다고 말씀드렸던 부분은 다음과 같습니다.

resample('10T')의 함정 주의:

단순히 10분 봉의 High(고가)만 보면 09:35의 급등이 포함되어 버립니다.

반드시 10분 봉의 **Close(종가)**나, 해당 시점의 스냅샷 데이터만을 기준으로 조건(40% >)을 검사해야 합니다.

미래 참조 방지:

09:40에 스캐닝을 했다면, 매수 주문(뜰채)은 09:40:01 이후의 데이터부터 체결 확인을 해야 합니다. 같은 09:30~09:40 봉 안에서 스캐닝과 체결이 동시에 일어난 것으로 처리하면 데이터 왜곡(Look-ahead Bias)이 발생합니다.

결론적으로 사용자님은 "장중의 현란한 흔들림(노이즈)에 속지 않고, 10분마다 굳건하게 자리를 지키는 종목만 골라서, 그것도 내가 원하는 가격(뜰채)에 올 때만 사겠다"는 아주 보수적이고 안전한 로직을 설계하신 것입니다.

2. 뜰채 (Scoop Net): "미리 깔아두기" (주문)
핵심 개념: "미리 가서 기다린다"

사용자님께서 가장 강조한 부분입니다. 주가가 40% 지점에 도달했을 때 보고 들어가는(시장가 매수) 것이 아닙니다.

스캐닝이 끝난 직후, 계산된 40% 가격에 미리 지정가 매수(Limit Order) 주문을 걸어두는 행위를 '뜰채를 댄다'고 표현했습니다.

비유:

낚싯바늘을 던져놓고 물고기가 물 때까지 기다리는 것과 같습니다. 주가가 순간적으로 '톡' 하고 떨어져서 뜰채(매수 주문)에 담기길 기다리는 수동적이지만 안전한 방식입니다.