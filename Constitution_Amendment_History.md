# 📚 Constitution Amendment History

**목적:** 헌법의 모든 개정 이유를 기록하는 "판례집(Case Law)"  
**대상:** 아키텍트, 시스템 유지보수자, 규칙 의심자  
**작성일:** 2026-01-10

---

## 🔍 v1.0.0 (2025-01-10) - The Genesis

**Amendment ID:** N/A (초판)  
**상황:** GapZone 프로젝트의 첫 번째 공식 헌법 수립  

### 주요 결정

#### 1. Chronological Sovereignty (시간 주권의 법칙)
**결정:** `for stock in stocks` 루프 금지 → `for timestamp` 루프 강제  
**근거:** 
- 종목별 루프는 "신의 시점(Omniscience)" 오류 → 자금 없이도 매수 가능
- 시간 순서 루프만이 실전의 "자금 제약" 재현 가능
- 이 원칙이 없으면 백테스트 결과는 "판타지"

#### 2. Single Slot Mandate (단일 슬롯)
**결정:** 동시 포지션 1개로 제한  
**근거:**
- 시드 $400으로 2개 포지션 동시 진입 불가능 (자금 부족)
- 실전과의 동기화 필수
- 이를 모르면 "내가 $10K 자본이면 몇 배 수익일까" 착각 유발

#### 3. Daily Reset
**결정:** 매일 $10,000으로 초기화  
**근거:**
- 급등주 매매는 일중 수익 실현(Intraday)이 특성
- 오버나잇 리스크 배제 (야간 갭다운 회피)
- 각 거래일을 독립 게임으로 간주

---

## 🔄 v1.1.0 (2025-01-10) - The First Contraction

**Amendment ID:** GZ-CONST-AMD-001  
**상황:** v1.0.0이 너무 상세 → "축약본" 제작 시도  
**문제점:** ⚠️ **핵심 검증 로직이 제거됨**

### 변경 사항 (추가)

#### Trailing Stop 명시화
**추가 이유:**
- v1.0.0에서 "익절" 방식이 모호함
- "수익이 나면 언제 팔아야 하는가?" 구현자마다 다르게 해석
- Trailing Stop으로 명확히 정의

**설정값 (첫 추정):**
- 활성화: +3% 수익
- 콜백: -1% 하락

#### EOD Protocol (장 종료 강제 청산)
**추가 이유:**
- 05:55 이후 신규 거래 금지 필요
- 그런데 기존 포지션은? → 05:55 강제 청산

### 소실된 것 ⚠️

#### 1. Validation Suite (5가지 검증 케이스)
- v1.0.0: Case 1~5 명확히 정의
- v1.1.0: 제거됨 (이유 불명)
- **영향:** Article 7의 "무효 사유"는 있는데, 검증 방법이 없음 → 실무 적용 불가

#### 2. Snapshot & Shift Logic 상세 설명
- v1.0.0: "정각 데이터 없으면 Fallback" 상세 설명
- v1.1.0: 명시되지 않음
- **영향:** 데이터 결측 시 처리 방식 불명확

### 평가

**평가:** ⚠️ **실패한 축약** (형식 간소화했으나 검증 로직 손실)

---

## 📈 v1.2.0 (2025-01-11) - The Second Wind

**Amendment ID:** GZ-CONST-AMD-002  
**상황:** v1.1.0의 모호함을 개선, v1.0.0의 기능 강화  
**핵심:** "매 10분마다 반복 스캔" 도입 + 갭 이중 기준

### 변경 사항

#### 1. Dynamic Rolling Watch (매 10분 스캔)
**개정 이유:**
- v1.0.0~v1.1.0: "장 시작 시 1회 스캔" 가정
- 실전에서는? 장 중에도 계속 모니터링 필요
- 급등주는 장 중에 올라가는 게 일반적 (장초반 갭업 아님)

**변경값:**
- Old: 장 시작 시 1회 스캔
- New: 매 10분마다 반복 스캔 (09:30, 09:40, 09:50...)

**근거:**
- 애프터마켓 폭등주나 뉴스 이슈 종목도 감지 가능
- 시뮬레이션이 실전과 더 가까워짐

#### 2. Gap Criteria: Dual Check
**도입 이유:**
- v1.0.0~v1.1.0: 단순히 (현재 - 어제 종가) / 어제 종가 = Gap %
- 문제: 애프터마켓에서 이미 20% 오른 종목도, 정규장 데이터로 다시 계산하면 Gap이 작아짐
- 예: 
  - 어제 종가: $100
  - 애프터 마켓: $120 (20% 상승)
  - 정규장 시작 09:30: $125
  - 단순 기준: ($125 - $100) / $100 = 25% ✓ (맞음)
  - BUT 애프터가 $120에서 시작했으니 실제는 +4.2%

**해결책:**
```
Gap = Max(Gap_A, Gap_B)
  Gap_A = (현재 - 정규장 종가) / 정규장 종가
  Gap_B = (현재 - 최종 데이터 종가) / 최종 종가
```
- Max를 취함으로써 더 큰 쪽 기준 사용
- 폭등 가능성을 놓치지 않음

#### 3. Aggressive Scoop (진입 기준 개선)
**변경:**
- Old: "계산된 목표가(Calculated_Target_Price)"
- New: "현재가(Current Price)" 기준

**이유:**
- v1.2.0의 "매 10분 스캔"과 연계
- 10분 스캔 시점에서의 현재가가 기준이 되어야 일관성 있음

---

## 🏛️ v1.3.0 (2026-01-10) - The Consolidation

**Amendment ID:** GZ-CONST-AMD-003  
**상황:** v1.1.0~v1.2.0의 핵심 누락을 복구, 사용자 요구사항 명시화  
**목표:** "통합 완성본" (검증 로직 + 신기능)

### 변경 사항 (신규 Article)

#### Article 1.3: Daily Trading Boundary
**신설 이유:**
- 사용자 요구: "파일 20251230_FLYE.csv는 20251230 당일에만 거래 가능"
- 문제: v1.0.0~v1.2.0에서 명시되지 않음
- 영향: 같은 파일로 여러 날 거래하는 오류 발생 가능

**규정:**
- 파일명 = 거래 가능 날짜
- 파일 내 과거 데이터 = 지표 계산용
- 파일 내 미래 데이터 = 금지

#### Article 1.4: Moving Average Timeframe
**신설 이유:**
- 사용자 요구: "200EMA는 1분봉 기준으로 계산"
- 문제: 다중 시간프레임 지표(1분, 5분, 15분 섞임) 가능성
- 영향: 같은 전략인데 시뮬과 실전 신호 불일치

**규정:**
- 모든 지표 = 1분봉 기준 (다중 시간프레임 금지)

#### Article 3.2: Per-Stock Trading Limit
**신설 이유:**
- 사용자 요구: "TSLA를 매수했다 팔았으면, 그날은 TSLA 추가 진입 금지"
- 문제: v1.0.0~v1.2.0에서 정의 없음
- 영향: 같은 종목을 반복 거래 (리스크 회피 원칙 위반)

**규정:**
- Daily One-Shot: 당일 1회만 거래
- 기록: REJECT:ALREADY_TRADED_TODAY

#### Validation Suite 복구 (Case 1~6)
**복구 이유:**
- v1.0.0에 있던 6가지 검증 케이스가 v1.1.0~v1.2.0에서 제거됨
- v1.3.0에서 복구
- Case 6 신규 추가 (Article 3.2 검증용)

### 평가

**평가:** ✅ **통합 완성본** (검증 로직 복구 + 사용자 요구사항 명시)

---

## 🔧 v1.4.0 (2026-01-10) - The Fix

**Amendment ID:** GZ-CONST-AMD-004  
**상황:** 실무 디버깅에서 발견된 "입법적 허점" 해결  
**핵심:** 성과 측정 정확화, 파라미터 최적화, 데이터 필드 명시

### 변경 사항

#### 1. Article 3.3 개정: Daily Reset & Cumulative Performance
**개정 배경:**
- **버그:** 일일 리셋 후 누적 수익이 계산되지 않음
- **발생 사례:** Day 1 PnL +$100 → Day 2 리셋 → 최종 출력 -$50 (Day 2만)
- **원인:** 매일 리셋하면서 누적 수익 기록을 따로 하지 않음

**해결책:**
```
매일 리셋: Operational_Balance = $10,000
누적 기록: Trade_Ledger에 매일의 PnL 추가

최종 PnL = Trade_Ledger 합계 (정답)
         NOT 마지막 날 잔고 (오답)
```

**수치적 영향:**
- 5거래일 기준
- 각 날 PnL = [+100, -50, +150, -20, +80]
- 최종 누적 = +260 (레저 합계)
- 최종 잔고 = $10,080 (기준: $10,000)

#### 2. Article 5.0 신설: Sign Error in SL/TP
**신설 배경:**
- **버그:** EMA 전략에서 100% 승률 (모든 거래 수익)
- **원인:** SL 계산에서 부호 오류
  ```
  ❌ Wrong: SL = Entry * (1 + SL_Ratio) 
     Entry=100, SL_Ratio=-0.05 → SL=95 (맞는데...)
     Entry=100, SL_Ratio=-0.03 → SL=97 (맞는데...)
     But: SL_Ratio=0.05 (양수) → SL=105 (손절이 익절 위에!)
  
  ✅ Correct: SL = Entry * (1 - abs(SL_Ratio))
     Entry=100, SL=-0.05 → SL=95 ✓
     Entry=100, SL=-0.03 → SL=97 ✓
  ```

**해결책:**
- 모든 SL/TP/TS 계산에 `abs()` 필수 사용
- Code review 체크: `abs()` 있는지 확인

#### 3. Article 5.1 신설: Trade Logs 필드 명시
**신설 배경:**
- **버그:** visualization.py에서 KeyError (필드 누락)
- **원인:** entry_price, exit_price 등 핵심 필드가 없음
- **영향:** 거래 분석 불가능

**해결책:**
```
필수 11개 필드:
date, strategy, ticker, entry_time, entry_price,
exit_time, exit_price, qty, pnl, return_pct, reason
```

#### 4. Article 5.2 신설: Performance Metrics
**신설 배경:**
- **모호함:** "승률 계산 방식이 다양함"
  - 누군가: (수익 거래) / (전체)
  - 누군가: (수익 거래) / (손실 거래) 
  - 누군가: (수익 거래 수익) / (손실 거래 손실)

**해결책:**
```
승률 = (PnL > 0인 거래) / (Total Trades) * 100%
       (분모는 명확히 Total Trades)
```

#### 5. Article 2 개정: 파라미터 최적화
**최적화 배경:**
- optimizer.py 실행 결과를 헌법에 반영
- v1.3.0의 "추정값" → v1.4.0의 "검증값"

**수치 변경:**

**GapZone:**
```
Gap Threshold:    5%   → 15%   (↑ 3배, 더 선별적)
  근거: Gap 5%는 너무 낮음 (과도한 거래)
        Gap 15% 이상만 진입 시 승률 ↑

Stop Loss:       -3%  → -5%   (↑ 손실 확대)
  근거: -3%은 너무 타이트 (손절 자주 발동)
        -5%로 확대 시 Win Rate ↑ (손절 시 손실량도 ↑이지만 횟수↓)

Trailing Stop:    3% → 5%   (↑ 더 늦게 활성화)
  근거: 3% 수익은 금방 도달 (손절 많음)
        5% 수익 도달 시만 추격 (안정성 ↑)

Callback:        1%  → 2%   (↑ 더 관대)
  근거: 1%는 노이즈에 쉽게 반응
        2%로 확대 시 추격 더 잘됨
```

**EMA:**
```
Logic:          단순 터치 → Safe Pullback (패턴 추가)
  근거: 터치만으로는 신뢰도 낮음 (위험)
        지지 + 눌림 + 양봉 3가지 확인 필수

Tolerance:       1%  → 3%   (↑ 감지 범위 확대)
  근거: 1%는 너무 타이트
        3%로 확대 시 더 많은 신호 감지

Stop Loss:      -3%  → -7%   (↑ 휩소 방어)
  근거: EMA는 잘못된 신호 가능 (추세 역전)
        -7%로 손실 제한해야 안전
```

**ORB:**
```
Timeframe:      30분 → 15분  (↓ 더 빨리 진입)
  근거: 30분은 너무 김
        15분 고점 돌파로 더 민첩한 진입

Target:          5% → 15%  (↑ 익절 목표 확대)
  근거: 5%은 너무 보수적
        15% 목표로 더 공격적

Trailing:        5% → 5% (변화 없음)
  근거: 5% 콜백은 최적값 (추세 추종에 적합)
```

---

## 💪 v1.5.0 (2026-01-10) - The Diet

**Amendment ID:** GZ-CONST-AMD-005 (다이어트 에디션)  
**상황:** v1.4.0 (700줄) → v1.5.0 (400줄) "법전 간소화"  
**목표:** 개발자가 읽기 쉬운 "빠른 지침서" 제작

### 변경 사항

#### 1. 형식 간소화
- Old: 상세한 설명 + 이유 + 배경
- New: 규칙만 명확히 + 태그로 근거 표시 (예: [optimizer.py 검증됨])

#### 2. 구조 분리
- v1.5.0: 실행 로직 (본문)
- Constitution_Amendment_History.md: 변경 이유 (부록)

#### 3. Quick Reference 추가
- 개발자가 10초 안에 필수 항목 확인 가능한 체크리스트

### 유지된 것

✅ Article 1~7 (기본 규칙 100% 유지)  
✅ Strategy Parameters (최적값 100% 유지)  
✅ Validation Suite (Case 1~7 100% 유지)  
✅ Trade Log Fields (11개 100% 유지)  

### 제거된 것

⚠️ Amendment History (본 파일로 이동)  
⚠️ Detailed Rationale (한 줄 요약으로 축약)  
⚠️ Version Comparison (최소화)  

---

## 🎯 Key Takeaways (각 버전의 핵심)

| Version | 핵심 기여 | 실수 |
|---------|--------|------|
| v1.0.0 | Chronological Loop 도입 (신의 시점 오류 제거) | 너무 상세 |
| v1.1.0 | Trailing Stop 명시화 | 검증 로직 제거 ⚠️ |
| v1.2.0 | Dynamic Rolling Watch (10분 스캔) + Gap 이중 기준 | - |
| v1.3.0 | Daily Boundary, Per-Stock Limit, Validation Suite 복구 | - |
| v1.4.0 | **Daily Reset PnL 정확화** + **SL/TP Sign Error 규정** + **파라미터 최적화** | 너무 김 |
| v1.5.0 | **간소화** (핵심만 남김) + **2-File 구조로 분리** | - |

---

## 📌 Future Amendments (다음 개정 시 고려사항)

### 예상 v1.6.0 (언제?)
- Multi-Symbol Slot (포지션 2개 이상) 필요 시
- Zone 2 이상으로 확대 시

### 예상 v1.7.0
- 실전 Live Trading 로그와 시뮬레이션 비교
- Discrepancy 발견 시 규칙 조정

### 예상 v2.0.0 (혁신적 변화)
- 새로운 전략 추가 (Momentum, Reversal 등)
- 시간 단위 변경 (1분 → 5분 봉 고민)

---

**END OF AMENDMENT HISTORY**

*"법전은 생명체다. 진화한다."*  
*"그 진화 과정을 알면, 규칙을 따르는 이유가 보인다."*

---

## 📚 How to Read This Document

**개발자:**
```
"이 항목이 왜 필요해?"
→ Constitution_Amendment_History에서 해당 버전 검색
→ "아, 이 버그 때문에 규칙이 생겼구나" 이해
```

**아키텍트:**
```
"다음 개정안을 제시하려면?"
→ Amendment History에서 패턴 분석
→ v1.0~v1.5의 진화 방향 이해
→ 논리적 개정안 제시
```

**새로운 팀원:**
```
"GapZone 헌법이 뭐 하는 거야?"
→ v1.0.0부터 읽기 시작 (30분)
→ 각 버전의 "왜?"를 이해 (1시간)
→ The_GapZone_Backtesting_Constitution_v1.5.md는 참고만 (개발 중)
```